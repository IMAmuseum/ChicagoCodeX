<?php

/***********************************************************************
 *
 * Drupal Hooks
 *
 */


function osci_filters_init() {
    drupal_add_js(drupal_get_path('module', 'osci_filters').'/js/osci_filters.js', array('weight' => '5'));
}
/**
 * Implementation of hook_node_insert
 */
function osci_filters_node_insert(&$node) {
    dpm($node);
}

/**
 * Implementation of hook_node_update
 */
function osci_filters_node_update(&$node) {
    $node->body['und'][0]['value'] = _footnote_replace($node->body['und'][0]['value']);
    dpm($node);
}

/**
 * Implementation of hook_filter_info
 */
function osci_filters_filter_info() {
    $filters = array();

    // Footnotes
    $filters['osci_footnote'] = array(
        'title'             => t('Footnote filter'),
        'description'       => t('Allow filters for footnotes'),
        'process callback'  => '_filter_footnote',
        'settings callback' => '_filter_settings',
        'tips callback'     => '_filter_footnote_tips',
    );

    return $filters;
}

/**
 * Implementation of hook_wysiwyg_plugin
 */
function osci_filters_wysiwyg_plugin($editor, $version) {
    switch($editor) {
        case 'ckeditor':
/*
            return array(
                'osci_filters' => array(
                    'path'      => drupal_get_path('module', 'osci_filters').'/js/osci_filters.js',
                    'buttons'   => array(
                        'footnote' => t('OSCI - Footnote'),
                    ),
                    'load'      => TRUE,
                ),
            );
*/
    }
}

/**
 * Empty settings function, seems to be required by hook_filter_info
 */
function _filter_settings() {}

/***********************************************************************
 *
 * FOOTNOTE
 *
 */

/**
 * Process callback for filter
 */
function _filter_footnote($text, $filter, $format) {
    $regex = '/\[footnote:(.*?)\]/i';
    return preg_replace_callback($regex, '_process_footnote', $text);
}

/**
 * Regex replace callback
 */
function _process_footnote($text) {
    if (!is_numeric($text[1])) return $text[0]; 
    return l('Footnote', $_GET['q'], array('fragment' => 'footnote-'.$text[1]));
}

/**
 * Tooltip funcion
 */
function _filter_footnote_tips() {
    return t('Insert a footnote with [footnote:ID]');
}

/************** INSERT OTHER FILTER FUNCTIONS HERE ********************/


/***********************************************************************
 *
 * HELPER FUNCTIONS
 *
 */

function _footnote_replace($text) {
    dpm($text);
}
